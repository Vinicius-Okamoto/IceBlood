<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visão Geral - IceBlood</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.js"></script>

    <link rel="shortcut icon" href="../assets/img/dashboard/logo.png" type="image/x-icon">
    <link rel="stylesheet" href=".././css/macroDash.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <div id="header-left">
            <img src=".././assets/imgs/logo.png" alt="Logo do IceBlood">
            <h1>IceBlood</h1>
            <nav>
                <ul>
                    <li><a href="../dashboard/macroDash.html" class="active">Visão Geral</a></li>
                    <li><a href=".././dashboard/historico.html">Histórico</a></li>
                    <li><a href="https://lifesense.atlassian.net/servicedesk/customer/portal/1">Suporte</a></li>
                    <li><a href=".././index.html">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section>
            <h1>Câmaras Frias</h1>
            <p>Selecione uma câmara para ver o dashboard detalhado ou veja o comparativo abaixo.</p>

            <div class="container-camaras">
                <a href="camara1.html">
                    <h2 id="temp1">--ºC</h2>
                    <p>Camara 1</p>
                </a>
                <a href="camara2.html">
                    <h2 id="temp2">--ºC</h2>
                    <p>Camara 2</p>
                </a>
            </div>

            <h2>Comparativo de Temperaturas</h2>

            <div class="graficos-container">

                <div class="grafico-item">
                    <h3>Histórico de Temperaturas (Por Hora)</h3>
                    <canvas id="temperatureChart"></canvas>
                </div>

                <div class="grafico-item">
                    <h3>Máximas Diárias (Última Semana)</h3>
                    <canvas id="horaryChart"></canvas>
                </div>

            </div>
        </section>
    </main>
    <script>
        const TOKEN = sessionStorage.TOKEN_UNIDADE;

        function formatarHoraIsoToLabel(dtIso) {
            const d = new Date(dtIso);
            const h = d.getHours();
            return (h < 10 ? "0" + h : h) + "H";
        }

        function formatarDiaIsoToLabel(dtIso) {
            const d = new Date(dtIso);
            const dias = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            return dias[d.getDay()];
        }

        async function buscarDadosCamara(idCamara) {
            try {
                const res = await fetch(`/dashboard/temperaturas/${TOKEN}/${idCamara}`, { cache: 'no-store' });
                if (!res.ok) throw new Error();
                const dados = await res.json();
                return dados || [];
            } catch {
                return [];
            }
        }

        async function atualizarTemperaturas() {
            const dados1 = await buscarDadosCamara(1);
            const dados2 = await buscarDadosCamara(2);

            if (dados1.length > 0) {
                const u1 = dados1[dados1.length - 1];
                temp1.innerText = `${u1.tempAtual} ºC`;
            } else temp1.innerText = "-- ºC";

            if (dados2.length > 0) {
                const u2 = dados2[dados2.length - 1];
                temp2.innerText = `${u2.tempAtual} ºC`;
            } else temp2.innerText = "-- ºC";
        }

        let chartHistorico = null;

        async function montarGraficoHistorico() {
            const dados1 = await buscarDadosCamara(1);
            const dados2 = await buscarDadosCamara(2);
            if (dados1.length === 0 && dados2.length === 0) return;

            const labels = [];
            const temps1 = [];
            const temps2 = [];

            const base = dados1.length > 0 ? dados1 : dados2;
            for (let i = 0; i < base.length; i++) labels.push(formatarHoraIsoToLabel(base[i].dtHoraAtual));

            for (let i = 0; i < dados1.length; i++) temps1.push(Number(dados1[i].tempAtual));
            for (let i = 0; i < dados2.length; i++) temps2.push(Number(dados2[i].tempAtual));

            const ctx = document.getElementById('temperatureChart').getContext('2d');
            if (chartHistorico) chartHistorico.destroy();

            chartHistorico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Câmara 1', data: temps1, borderColor: '#B9030F', borderWidth: 2, tension: 0.4, fill: false },
                        { label: 'Câmara 2', data: temps2, borderColor: '#70160E', borderWidth: 2, tension: 0.4, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        let chartMaximas = null;

        async function montarGraficoMaximas() {
            const dados1 = await buscarDadosCamara(1);
            const dados2 = await buscarDadosCamara(2);
            if (dados1.length === 0 && dados2.length === 0) return;

            const porDia1 = {};
            const porDia2 = {};
            const labels = [];

            const addLabel = (dt) => {
                const dia = formatarDiaIsoToLabel(dt);
                if (labels.indexOf(dia) === -1) labels.push(dia);
            };

            for (let i = 0; i < dados1.length; i++) {
                const dia = formatarDiaIsoToLabel(dados1[i].dtHoraAtual);
                if (!porDia1[dia]) porDia1[dia] = [];
                porDia1[dia].push(Number(dados1[i].tempAtual));
                addLabel(dados1[i].dtHoraAtual);
            }

            for (let i = 0; i < dados2.length; i++) {
                const dia = formatarDiaIsoToLabel(dados2[i].dtHoraAtual);
                if (!porDia2[dia]) porDia2[dia] = [];
                porDia2[dia].push(Number(dados2[i].tempAtual));
                addLabel(dados2[i].dtHoraAtual);
            }

            const max1 = [];
            const max2 = [];

            const calcMax = (obj, dia) => {
                const arr = obj[dia] || [];
                if (arr.length === 0) return 0;
                let m = arr[0];
                for (let i = 1; i < arr.length; i++) if (arr[i] > m) m = arr[i];
                return m;
            };

            for (let i = 0; i < labels.length; i++) {
                max1.push(calcMax(porDia1, labels[i]));
                max2.push(calcMax(porDia2, labels[i]));
            }

            const ctx = document.getElementById('horaryChart').getContext('2d');
            if (chartMaximas) chartMaximas.destroy();

            chartMaximas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Câmara 1', data: max1, backgroundColor: '#B9030F' },
                        { label: 'Câmara 2', data: max2, backgroundColor: '#70160E' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function iniciarDash() {
            await atualizarTemperaturas();
            await montarGraficoHistorico();
            await montarGraficoMaximas();
        }

        window.onload = iniciarDash;

        setInterval(atualizarTemperaturas, 5000);
    </script>


</body>

</html>