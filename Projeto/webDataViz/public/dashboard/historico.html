<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico - IceBlood</title>
    <link rel="stylesheet" href=".././css/historico.css">
    <link rel="shortcut icon" href=".././assets/imgs/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div id="header-left">
            <img src=".././assets/imgs/logo.png" alt="Logo do IceBlood">
            <h1>IceBlood</h1>
            <nav>
                <ul>
                    <li><a href=".././dashboard/macroDash.html">Visão Geral</a></li>
                    <li><a href=".././dashboard/historico.html" class="active">Histórico</a></li>
                    <li><a href="https://lifesense.atlassian.net/servicedesk/customer/portal/1">Suporte</a></li>
                    <li><a href=".././index.html">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="historico-container-tabela">
    <h2 class="titulo-historico">Histórico</h2>

    <div class="filtro-container">
        <label for="filtro-camara">Filtrar por: </label>
        <select id="filtro-camara" onchange="filtrarHistorico()">
            <option value="0">Todas as Câmaras</option>
            <option value="1">Câmara 1</option>
            <option value="2">Câmara 2</option>
        </select>
    </div>
    
    <div class="historico_card_tabela" id="historico_tabela">
        
        <div class="header-tabela">
            <span class="coluna-titulo">Câmara</span>
            <span class="coluna-titulo">Evento</span>
            <span class="coluna-titulo">Data</span>
            <span class="coluna-titulo">Status</span>
        </div>

        <div id="container-linhas">
            </div>

    </div>
</section>
</body>

<script>
 
    let historicoCompleto = []; 
    let proximaAtualizacaoTemperatura;
    
    let idCamaraReal = 1; 
    let token = sessionStorage.TOKEN_UNIDADE || "TOKEN_TESTE";

    const containerLinhas = document.getElementById('container-linhas');
    const selectFiltro = document.getElementById('filtro-camara');

    window.onload = () => {
        obterDadosTemperatura();
    };

    function obterDadosTemperatura() {
        if (proximaAtualizacaoTemperatura != undefined) {
            clearTimeout(proximaAtualizacaoTemperatura);
        }

        fetch(`/dashboard/temperaturas/${token}/${idCamaraReal}`, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) { return []; }
                return response.json();
            })
            .then(respostaReal => {
                if (respostaReal.length === 0) {
                    exibirHistorico([]);
                    return;
                }

                let dadosCamara1 = respostaReal.slice(-5);

                // 2. CRIAR 5 REGISTROS SIMULADOS (MOCK)
                let dadosCamara2 = dadosCamara1.map(item => {
                    let tempOriginal = parseFloat(item.tempAtual);
                    let novaTemp = tempOriginal + 1.5; 

                    return {
                        ...item,            
                        idCamara: 2,        
                        tempAtual: novaTemp.toFixed(2)
                    };
                });

                let dadosCombinados = [...dadosCamara1, ...dadosCamara2];

                dadosCombinados.sort((a, b) => new Date(a.dtHoraAtual) - new Date(b.dtHoraAtual));

                processarDadosParaVariavelGlobal(dadosCombinados);

                filtrarHistorico();
            })
            .catch(error => {
                console.error("Erro: " + error.message);
            });
    }

    function processarDadosParaVariavelGlobal(dadosBrutos) {
        historicoCompleto = dadosBrutos.map(item => {
            return {
                camara: item.idCamara, 
                horario: item.dtHoraAtual,
                temperatura: item.tempAtual 
            };
        });
    }

    // --- NOVA FUNÇÃO DE FILTRO ---
    function filtrarHistorico() {
    
        const opcaoSelecionada = selectFiltro.value;

        let listaFiltrada;

        if (opcaoSelecionada == "0") {

            listaFiltrada = historicoCompleto;
        } else {
  
            listaFiltrada = historicoCompleto.filter(item => item.camara == opcaoSelecionada);
        }

        exibirHistorico(listaFiltrada);
    }

    function exibirHistorico(listaParaExibir) {
        containerLinhas.innerHTML = ""; 

        const MIN_IDEAL = 2.0;
        const MAX_IDEAL = 6.0;

        if(listaParaExibir.length === 0) {
            containerLinhas.innerHTML = "<div class='item-tabela'>Sem dados para exibir</div>";
            return;
        }

        // Loop invertido para os mais recentes ficarem no topo
        for (let i = listaParaExibir.length - 1; i >= 0; i--) {
            
            let dataFormatada = new Date(listaParaExibir[i].horario).toLocaleString("pt-BR");
            let temp = Number(listaParaExibir[i].temperatura);
            
            let textoStatus = "Ideal";
            let classeStatus = "status-ideal-tabela";

            if (temp < MIN_IDEAL || temp > MAX_IDEAL) {
                textoStatus = "Crítico";
                classeStatus = "status-critico-tabela"; 
            }

            containerLinhas.innerHTML += `
                <div class="item-tabela">
                    <span class="coluna-dado">Câmara ${listaParaExibir[i].camara}</span>
                    <span class="coluna-dado">${temp.toFixed(1)}°C</span> 
                    <span class="coluna-dado">${dataFormatada}</span> 
                    <span class="status-faixa ${classeStatus}">${textoStatus}</span>
                </div>
            `;
        }
    }
</script>
</html>